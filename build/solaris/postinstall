
#!/bin/bash

# NCPA Post-installation script for Solaris

echo "NCPA: Running post-installation setup..."

# Set proper ownership and permissions
chown -R nagios:nagios /usr/local/ncpa/var
chown nagios:nagios /usr/local/ncpa/etc /usr/local/ncpa/etc/*.cfg*
chmod -R 755 /usr/local/ncpa/var
chmod 755 /usr/local/ncpa/etc
chmod 644 /usr/local/ncpa/etc/*.cfg*

# Create run directory
mkdir -p /usr/local/ncpa/var/run
chown nagios:nagios /usr/local/ncpa/var/run
chmod 755 /usr/local/ncpa/var/run

# Create SMF service manifest
cat > /var/svc/manifest/application/ncpa.xml << 'EOF'
<?xml version="1.0"?>
<!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1">
<service_bundle type='manifest' name='ncpa'>
  <service name='application/ncpa' type='service' version='1'>
    <create_default_instance enabled='false' />
    <single_instance />
    <dependency name='multi-user' grouping='require_all' restart_on='none' type='service'>
      <service_fmri value='svc:/milestone/multi-user:default' />
    </dependency>
    <dependency name='filesystem' grouping='require_all' restart_on='none' type='service'>
      <service_fmri value='svc:/system/filesystem/local' />
    </dependency>
    <exec_method type='method' name='start' exec='/usr/local/ncpa/ncpa --start' timeout_seconds='60'>
      <method_context working_directory='/usr/local/ncpa'>
        <method_credential user='nagios' group='nagios' />
        <method_environment>
          <envvar name='LD_LIBRARY_PATH' value='/usr/local/ncpa/lib:/usr/local/lib:/lib:/usr/lib' />
          <envvar name='PATH' value='/usr/local/bin:/usr/bin:/bin' />
        </method_environment>
      </method_context>
    </exec_method>
    <exec_method type='method' name='stop' exec=':kill' timeout_seconds='60' />
    <property_group name='startd' type='framework'>
      <propval name='duration' type='astring' value='contract' />
      <propval name='ignore_error' type='astring' value='core,signal' />
    </property_group>
    <property_group name='application' type='application'>
      <stability value='Evolving' />
    </property_group>
    <template>
      <common_name>
        <loctext xml:lang='C'>Nagios Cross-Platform Agent</loctext>
      </common_name>
      <documentation>
        <manpage title='ncpa' section='1' />
      </documentation>
    </template>
  </service>
</service_bundle>
EOF

# Validate the SMF manifest first
echo "NCPA: Validating SMF manifest..."
if svccfg validate /var/svc/manifest/application/ncpa.xml; then
    echo "NCPA: SMF manifest validation passed"
else
    echo "NCPA: ERROR - SMF manifest validation failed"
    echo "NCPA: Manifest content:"
    tail -20 /var/svc/manifest/application/ncpa.xml
    exit 1
fi

# Remove any existing service first
echo "NCPA: Removing any existing SMF service..."
svccfg delete application/ncpa 2>/dev/null || true
svccfg delete site/ncpa 2>/dev/null || true

# Create service manually using svccfg commands
echo "NCPA: Creating SMF service manually..."
svccfg << EOF
add application/ncpa
select application/ncpa
add default instance
select default
setprop startd/timeout_seconds = count: 60
setprop startd/ignore_error = astring: core,signal
setprop application/auto_enable = boolean: false
exit
EOF

# Set the start method
echo "NCPA: Setting service start method..."
svccfg << EOF
select application/ncpa:default
setprop start/exec = astring: "/usr/local/ncpa/ncpa --start"
setprop start/timeout_seconds = count: 60
setprop start/user = astring: nagios
setprop start/group = astring: nagios
setprop start/working_directory = astring: /usr/local/ncpa
setprop start/environment = astring: ( "LD_LIBRARY_PATH=/usr/local/ncpa/lib:/usr/local/lib:/lib:/usr/lib" "PATH=/usr/local/bin:/usr/bin:/bin" )
exit
EOF

# Set the stop method
echo "NCPA: Setting service stop method..."
svccfg << EOF
select application/ncpa:default
setprop stop/exec = astring: ":kill"
setprop stop/timeout_seconds = count: 60
exit
EOF

# Add dependencies
echo "NCPA: Adding service dependencies..."
svccfg << EOF
select application/ncpa
add dependency multi-user type service
select dependency multi-user
setprop grouping = astring: require_all
setprop restart_on = astring: none
setprop entities = fmri: svc:/milestone/multi-user:default
select ..
add dependency filesystem type service
select dependency filesystem
setprop grouping = astring: require_all
setprop restart_on = astring: none
setprop entities = fmri: svc:/system/filesystem/local
exit
EOF

# Refresh the service
echo "NCPA: Refreshing service configuration..."
svccfg -s application/ncpa refresh

# Wait a moment for SMF to process
sleep 3

# Check if service was imported with detailed diagnostics
echo "NCPA: Checking if service was imported..."
if svcs application/ncpa >/dev/null 2>&1; then
    echo "NCPA: Service found in SMF repository"
    echo "NCPA: Current service status:"
    svcs -l application/ncpa
    
    # Enable the service  
    echo "NCPA: Enabling SMF service..."
    if svcadm enable application/ncpa; then
        echo "NCPA: Service enabled successfully"
        
        # Wait a moment and check status
        sleep 5
        service_status=$(svcs -H -o state application/ncpa 2>/dev/null)
        echo "NCPA: Service status: $service_status"
        
        if [ "$service_status" = "online" ]; then
            echo "NCPA: Service is running successfully"
        else
            echo "NCPA: Service is not online yet - status: $service_status"
            echo "NCPA: Service details:"
            svcs -xv application/ncpa
            echo "NCPA: You may need to check the service logs and start manually:"
            echo "NCPA:   sudo tail -f /var/svc/log/application-ncpa:default.log"
            echo "NCPA:   sudo svcadm restart application/ncpa"
        fi
    else
        echo "NCPA: WARNING - Failed to enable service"
        echo "NCPA: Service status:"
        svcs -xv application/ncpa
    fi
else
    echo "NCPA: ERROR - Service not found in SMF repository after import"
    echo "NCPA: Available services matching 'ncpa':"
    svcs | grep -i ncpa || echo "NCPA: No services found matching 'ncpa'"
    echo "NCPA: All services in application category:"
    svcs | grep application/ | head -5 || echo "NCPA: No services found in application category"
    echo "NCPA: Checking manifest file:"
    ls -la /var/svc/manifest/application/ncpa.xml
fi

echo "NCPA: Post-installation completed."
echo "NCPA: To manually start the service later, run: sudo svcadm enable application/ncpa"
