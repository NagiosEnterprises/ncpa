
#!/bin/bash

# NCPA Post-installation script for Solaris

echo "NCPA: Running post-installation setup..."

# Set proper ownership and permissions
chown -R nagios:nagios /usr/local/ncpa/var
chown nagios:nagios /usr/local/ncpa/etc /usr/local/ncpa/etc/*.cfg*
chmod -R 755 /usr/local/ncpa/var
chmod 755 /usr/local/ncpa/etc
chmod 644 /usr/local/ncpa/etc/*.cfg*

# Create run directory
mkdir -p /usr/local/ncpa/var/run
chown nagios:nagios /usr/local/ncpa/var/run
chmod 755 /usr/local/ncpa/var/run

# Create SMF service manifest
cat > /var/svc/manifest/application/ncpa.xml << 'EOF'
<?xml version="1.0"?>
<!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1">
<service_bundle type='manifest' name='ncpa'>
  <service name='application/ncpa' type='service' version='1'>
    <create_default_instance enabled='false' />
    <single_instance />
    <dependency name='multi-user' grouping='require_all' restart_on='none' type='service'>
      <service_fmri value='svc:/milestone/multi-user:default' />
    </dependency>
    <dependency name='filesystem' grouping='require_all' restart_on='none' type='service'>
      <service_fmri value='svc:/system/filesystem/local' />
    </dependency>
    <exec_method type='method' name='start' exec='/usr/local/ncpa/ncpa --start' timeout_seconds='60'>
      <method_context working_directory='/usr/local/ncpa'>
        <method_credential user='nagios' group='nagios' />
        <method_environment>
          <envvar name='LD_LIBRARY_PATH' value='/usr/local/ncpa/lib:/usr/local/lib:/lib:/usr/lib' />
          <envvar name='PATH' value='/usr/local/bin:/usr/bin:/bin' />
        </method_environment>
      </method_context>
    </exec_method>
    <exec_method type='method' name='stop' exec=':kill' timeout_seconds='60' />
    <property_group name='startd' type='framework'>
      <propval name='duration' type='astring' value='contract' />
      <propval name='ignore_error' type='astring' value='core,signal' />
    </property_group>
    <property_group name='application' type='application'>
      <stability value='Evolving' />
    </property_group>
    <template>
      <common_name>
        <loctext xml:lang='C'>Nagios Cross-Platform Agent</loctext>
      </common_name>
      <documentation>
        <manpage title='ncpa' section='1' />
      </documentation>
    </template>
  </service>
</service_bundle>
EOF

# Validate the SMF manifest first
echo "NCPA: Validating SMF manifest..."
if svccfg validate /var/svc/manifest/application/ncpa.xml; then
    echo "NCPA: SMF manifest validation passed"
else
    echo "NCPA: ERROR - SMF manifest validation failed"
    echo "NCPA: Manifest content:"
    tail -20 /var/svc/manifest/application/ncpa.xml
    exit 1
fi

# Remove any existing service first
echo "NCPA: Removing any existing SMF service..."
svccfg delete application/ncpa 2>/dev/null || true
svccfg delete site/ncpa 2>/dev/null || true

# Try importing the XML manifest again with detailed error reporting
echo "NCPA: Importing SMF service from manifest..."
if svccfg import /var/svc/manifest/application/ncpa.xml 2>&1; then
    echo "NCPA: SMF service imported successfully"
else
    echo "NCPA: Import failed, trying alternative approach..."
    
    # Create a temporary manifest in /tmp and try importing from there
    cp /var/svc/manifest/application/ncpa.xml /tmp/ncpa.xml
    chmod 644 /tmp/ncpa.xml
    
    echo "NCPA: Trying import from /tmp/ncpa.xml..."
    if svccfg import /tmp/ncpa.xml 2>&1; then
        echo "NCPA: SMF service imported from temporary location"
    else
        echo "NCPA: Both import attempts failed, creating basic service manually..."
        
        # Last resort: create a very basic service
        svccfg -s svc:/ add application/ncpa service
        svccfg -s application/ncpa add default instance
        svccfg -s application/ncpa:default addpg start method
        svccfg -s application/ncpa:default setprop start/exec = astring: "/usr/local/ncpa/ncpa --start"
        svccfg -s application/ncpa:default setprop start/timeout_seconds = count: 60
        svccfg -s application/ncpa:default addpg stop method  
        svccfg -s application/ncpa:default setprop stop/exec = astring: ":kill"
        svccfg -s application/ncpa:default setprop stop/timeout_seconds = count: 60
    fi
    
    rm -f /tmp/ncpa.xml
fi

# Refresh the service
echo "NCPA: Refreshing service configuration..."
svccfg -s application/ncpa refresh 2>/dev/null || true

# Wait a moment for SMF to process
sleep 3

# Check if service was imported with detailed diagnostics
echo "NCPA: Checking if service was imported..."
echo "NCPA: Debugging - checking service with different methods..."
echo "NCPA: Method 1 - svcs application/ncpa:"
svcs application/ncpa 2>&1 || echo "  Service not found with method 1"
echo "NCPA: Method 2 - svcs -a | grep ncpa:"
svcs -a | grep ncpa || echo "  No services found containing 'ncpa'"
echo "NCPA: Method 3 - svcs -a | grep application:"
svcs -a | grep application | head -3 || echo "  No application services found"
echo "NCPA: Method 4 - svccfg list application/ncpa:"
svccfg list application/ncpa 2>&1 || echo "  Service not found in svccfg"

if svcs application/ncpa >/dev/null 2>&1; then
    echo "NCPA: Service found in SMF repository"
    echo "NCPA: Current service status:"
    svcs -l application/ncpa
    
    # Enable the service  
    echo "NCPA: Enabling SMF service..."
    if svcadm enable application/ncpa; then
        echo "NCPA: Service enabled successfully"
        
        # Wait a moment and check status
        sleep 5
        service_status=$(svcs -H -o state application/ncpa 2>/dev/null)
        echo "NCPA: Service status: $service_status"
        
        if [ "$service_status" = "online" ]; then
            echo "NCPA: Service is running successfully"
        else
            echo "NCPA: Service is not online yet - status: $service_status"
            echo "NCPA: Service details:"
            svcs -xv application/ncpa
            echo "NCPA: You may need to check the service logs and start manually:"
            echo "NCPA:   sudo tail -f /var/svc/log/application-ncpa:default.log"
            echo "NCPA:   sudo svcadm restart application/ncpa"
        fi
    else
        echo "NCPA: WARNING - Failed to enable service"
        echo "NCPA: Service status:"
        svcs -xv application/ncpa
    fi
else
    echo "NCPA: Service not visible via svcs, but exists in repository"
    echo "NCPA: Attempting to force service refresh and enable..."
    
    # Force refresh the service
    svccfg -s application/ncpa refresh 2>&1 || echo "NCPA: Direct refresh failed"
    svccfg -s application/ncpa:default refresh 2>&1 || echo "NCPA: Instance refresh failed"
    
    # Wait for SMF to process the refresh
    sleep 5
    
    # Try to enable the service by instance
    echo "NCPA: Trying to enable by full instance name..."
    if svcadm enable application/ncpa:default 2>&1; then
        echo "NCPA: Service enabled successfully by instance name"
        
        # Wait and check status
        sleep 5
        if svcs application/ncpa:default >/dev/null 2>&1; then
            service_status=$(svcs -H -o state application/ncpa:default 2>/dev/null)
            echo "NCPA: Service status: $service_status"
            
            if [ "$service_status" = "online" ]; then
                echo "NCPA: Service is running successfully"
            else
                echo "NCPA: Service enabled but not online - status: $service_status"
                echo "NCPA: Service details:"
                svcs -xv application/ncpa:default 2>&1 || echo "NCPA: Could not get service details"
                echo "NCPA: Check service logs:"
                echo "NCPA:   sudo tail -f /var/svc/log/application-ncpa:default.log"
            fi
        else
            echo "NCPA: Service still not visible after enable attempt"
        fi
    else
        echo "NCPA: Failed to enable service by instance name"
        echo "NCPA: Trying manual property changes..."
        
        # Try to manually set the service to enabled
        svccfg -s application/ncpa:default setprop general/enabled = boolean: true 2>&1 || echo "NCPA: Failed to set enabled property"
        svccfg -s application/ncpa:default refresh 2>&1 || echo "NCPA: Failed to refresh after property change"
        
        sleep 3
        echo "NCPA: Final status check..."
        svcs application/ncpa:default 2>&1 || echo "NCPA: Service still not accessible"
    fi
    
    echo "NCPA: Available services matching 'ncpa':"
    svcs -a | grep ncpa || echo "NCPA: No services found matching 'ncpa'"
    echo "NCPA: All services in application category:"
    svcs -a | grep application | head -5 || echo "NCPA: No services found in application category"
    echo "NCPA: Checking manifest file:"
    ls -la /var/svc/manifest/application/ncpa.xml
    echo "NCPA: Checking SMF repository integrity:"
    svccfg inventory /var/svc/manifest/application/ncpa.xml 2>&1 || echo "NCPA: Inventory check failed"
fi

echo "NCPA: Post-installation completed."
echo "NCPA: To manually start the service later, run: sudo svcadm enable application/ncpa"
