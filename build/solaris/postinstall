
#!/bin/bash

# NCPA Post-installation script for Solaris

echo "NCPA: Running post-installation setup..."

# Set proper ownership and permissions
chown -R nagios:nagios /usr/local/ncpa/var
chown nagios:nagios /usr/local/ncpa/etc /usr/local/ncpa/etc/*.cfg*
chmod -R 755 /usr/local/ncpa/var
chmod 755 /usr/local/ncpa/etc
chmod 644 /usr/local/ncpa/etc/*.cfg*

# Create run directory
mkdir -p /usr/local/ncpa/var/run
chown nagios:nagios /usr/local/ncpa/var/run
chmod 755 /usr/local/ncpa/var/run

# Create SMF service manifest
cat > /var/svc/manifest/site/ncpa.xml << 'EOF'
<?xml version="1.0"?>
<!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1">
<service_bundle type='manifest' name='ncpa'>
  <service name='site/ncpa' type='service' version='1'>
    <create_default_instance enabled='false' />
    <single_instance />
    <dependency name='network' grouping='require_all' restart_on='none' type='service'>
      <service_fmri value='svc:/milestone/network:default' />
    </dependency>
    <dependency name='filesystem' grouping='require_all' restart_on='none' type='service'>
      <service_fmri value='svc:/system/filesystem/local' />
    </dependency>
    <exec_method type='method' name='start' exec='/usr/local/ncpa/ncpa --start' timeout_seconds='60'>
      <method_context working_directory='/usr/local/ncpa'>
        <method_credential user='nagios' group='nagios' />
        <method_environment>
          <envvar name='LD_LIBRARY_PATH' value='/usr/local/ncpa/lib:/usr/local/lib:/lib:/usr/lib' />
          <envvar name='PATH' value='/usr/local/bin:/usr/bin:/bin' />
        </method_environment>
      </method_context>
    </exec_method>
    <exec_method type='method' name='stop' exec=':kill' timeout_seconds='60' />
    <property_group name='startd' type='framework'>
      <propval name='duration' type='astring' value='contract' />
      <propval name='ignore_error' type='astring' value='core,signal' />
    </property_group>
    <property_group name='application' type='application'>
      <stability value='Evolving' />
    </property_group>
    <stability value='Evolving' />
    <template>
      <common_name>
        <loctext xml:lang='C'>Nagios Cross-Platform Agent</loctext>
      </common_name>
      <documentation>
        <manpage title='ncpa' section='1' />
      </documentation>
    </template>
  </service>
</service_bundle>
EOF

# Import the service
echo "NCPA: Importing SMF service..."
if svccfg import /var/svc/manifest/site/ncpa.xml; then
    echo "NCPA: SMF service imported successfully"
else
    echo "NCPA: WARNING - SMF service import failed"
fi

# Wait a moment for SMF to process
sleep 2

# Check if service was imported
if svccfg list | grep -q site/ncpa; then
    echo "NCPA: Service found in SMF repository"
    
    # Enable the service  
    echo "NCPA: Enabling SMF service..."
    if svcadm enable site/ncpa; then
        echo "NCPA: Service enabled successfully"
        
        # Wait a moment and check status
        sleep 3
        service_status=$(svcs -H -o state site/ncpa 2>/dev/null)
        echo "NCPA: Service status: $service_status"
        
        if [ "$service_status" = "online" ]; then
            echo "NCPA: Service is running successfully"
        else
            echo "NCPA: Service is not online yet - status: $service_status"
            echo "NCPA: You may need to check the service logs and start manually:"
            echo "NCPA:   sudo tail -f /var/svc/log/site-ncpa:default.log"
            echo "NCPA:   sudo svcadm restart site/ncpa"
        fi
    else
        echo "NCPA: WARNING - Failed to enable service"
    fi
else
    echo "NCPA: ERROR - Service not found in SMF repository after import"
fi

echo "NCPA: Post-installation completed."
echo "NCPA: To manually start the service later, run: sudo svcadm enable site/ncpa"
