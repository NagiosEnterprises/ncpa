
#!/bin/bash

# NCPA Pre-removal script for Solaris
# Set timeout to prevent hanging during package removal
set -m  # Enable job control
trap 'echo "NCPA: Pre-removal timeout, continuing..."; exit 0' TERM

echo "NCPA: Running pre-removal cleanup..."

# Stop NCPA using the service script if available
echo "NCPA: Stopping NCPA service..."
if [ -x "/usr/local/bin/ncpa-service" ]; then
    timeout 30 /usr/local/bin/ncpa-service stop 2>/dev/null || true
    echo "NCPA: Service stopped using service script"
fi

# Also try traditional SMF methods (without synchronous wait to prevent hanging)
timeout 10 svcadm disable site/ncpa 2>/dev/null || true
timeout 10 svcadm disable application/ncpa 2>/dev/null || true

# Wait a bit for the service to stop (but don't wait synchronously)
sleep 3

# Check if the services exist before trying to delete them (with timeout)
if timeout 5 svcs site/ncpa >/dev/null 2>&1; then
    echo "NCPA: Removing site/ncpa SMF service..."
    timeout 10 svccfg delete site/ncpa 2>/dev/null || true
fi

if timeout 5 svcs application/ncpa >/dev/null 2>&1; then
    echo "NCPA: Removing application/ncpa SMF service..."
    timeout 10 svccfg delete application/ncpa 2>/dev/null || true
fi

# Remove startup links
echo "NCPA: Removing startup links..."
for level in 0 1 2 3 6; do
    rm -f "/etc/rc${level}.d/S99ncpa" 2>/dev/null || true
    rm -f "/etc/rc${level}.d/K01ncpa" 2>/dev/null || true
done

# Remove service scripts
echo "NCPA: Removing service scripts..."
rm -f /usr/local/bin/ncpa-service 2>/dev/null || true
rm -f /usr/local/bin/ncpa-start.sh 2>/dev/null || true
rm -f /etc/init.d/ncpa 2>/dev/null || true

# Remove the service manifest files
rm -f /var/svc/manifest/site/ncpa.xml
rm -f /var/svc/manifest/application/ncpa.xml

# Clean up any remaining NCPA processes
echo "NCPA: Performing comprehensive process cleanup..."
timeout 120 bash -c '
for pattern in "/usr/local/ncpa/ncpa" "ncpa" "/usr/local/ncpa"; do
    pids=$(pgrep -f "$pattern" 2>/dev/null)
    if [ -n "$pids" ]; then
        echo "NCPA: Found processes with pattern '\''$pattern'\'': $pids"
        for pid in $pids; do
            echo "NCPA: Stopping process $pid..."
            kill $pid 2>/dev/null || true
            sleep 1
        done
    fi
done
' || true

# Wait and verify cleanup
sleep 2
remaining=$(pgrep -f "/usr/local/ncpa" 2>/dev/null | wc -l || echo "0")
if [ "$remaining" -gt 0 ]; then
    echo "NCPA: Warning: $remaining processes may still be running"
    # Final aggressive cleanup
    pkill -9 -f "/usr/local/ncpa" 2>/dev/null || true
    echo "NCPA: Performed final aggressive cleanup"
else
    echo "NCPA: All processes stopped successfully"
fi

# Clean up runtime files
echo "NCPA: Cleaning up runtime files..."
rm -rf /usr/local/ncpa/var/run
rm -f /usr/local/ncpa/var/*.crt
rm -f /usr/local/ncpa/var/*.db  
rm -f /usr/local/ncpa/var/*.key
rm -f /usr/local/ncpa/var/*.pid

# Remove lock files
rm -f /var/lock/subsys/ncpa 2>/dev/null || true

echo "NCPA: Pre-removal completed."
