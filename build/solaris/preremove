
#!/bin/bash

# NCPA Pre-removal script for Solaris

echo "NCPA: Running pre-removal cleanup..."

# Stop NCPA using the service script if available
echo "NCPA: Stopping NCPA service..."
if [ -x "/usr/local/bin/ncpa-service" ]; then
    /usr/local/bin/ncpa-service stop
    echo "NCPA: Service stopped using service script"
fi

# Also try traditional SMF methods
svcadm disable -s site/ncpa 2>/dev/null || true
svcadm disable -s application/ncpa 2>/dev/null || true

# Wait a bit for the service to stop
sleep 2

# Check if the services exist before trying to delete them
if svcs site/ncpa >/dev/null 2>&1; then
    echo "NCPA: Removing site/ncpa SMF service..."
    svccfg delete site/ncpa 2>/dev/null || true
fi

if svcs application/ncpa >/dev/null 2>&1; then
    echo "NCPA: Removing application/ncpa SMF service..."
    svccfg delete application/ncpa 2>/dev/null || true
fi

# Remove startup links
echo "NCPA: Removing startup links..."
for level in 0 1 2 3 6; do
    rm -f "/etc/rc${level}.d/S99ncpa" 2>/dev/null || true
    rm -f "/etc/rc${level}.d/K01ncpa" 2>/dev/null || true
done

# Remove service scripts
echo "NCPA: Removing service scripts..."
rm -f /usr/local/bin/ncpa-service 2>/dev/null || true
rm -f /usr/local/bin/ncpa-start.sh 2>/dev/null || true
rm -f /etc/init.d/ncpa 2>/dev/null || true

# Remove the service manifest files
rm -f /var/svc/manifest/site/ncpa.xml
rm -f /var/svc/manifest/application/ncpa.xml

# # Clean up any remaining NCPA processes
# echo "NCPA: Performing comprehensive process cleanup..."
# for pattern in "/usr/local/ncpa/ncpa" "ncpa" "/usr/local/ncpa"; do
#     pids=$(pgrep -f "$pattern" 2>/dev/null)
#     if [ -n "$pids" ]; then
#         echo "NCPA: Found processes with pattern '$pattern': $pids"
#         for pid in $pids; do
#             echo "NCPA: Stopping process $pid..."
#             kill $pid 2>/dev/null || true
#             sleep 1
            
#             # Force kill if still running
#             if ps -p $pid > /dev/null 2>&1; then
#                 echo "NCPA: Force killing process $pid..."
#                 kill -9 $pid 2>/dev/null || true
#             fi
#         done
#     fi
# done

# Wait and verify cleanup
sleep 2
remaining=$(pgrep -f "/usr/local/ncpa" 2>/dev/null | wc -l)
if [ "$remaining" -gt 0 ]; then
    echo "NCPA: Warning: $remaining processes may still be running"
    # Final aggressive cleanup
    pkill -9 -f "/usr/local/ncpa" 2>/dev/null || true
    echo "NCPA: Performed final aggressive cleanup"
else
    echo "NCPA: All processes stopped successfully"
fi

# Clean up runtime files
echo "NCPA: Cleaning up runtime files..."
rm -rf /usr/local/ncpa/var/run
rm -f /usr/local/ncpa/var/*.crt
rm -f /usr/local/ncpa/var/*.db  
rm -f /usr/local/ncpa/var/*.key
rm -f /usr/local/ncpa/var/*.pid

# Remove lock files
rm -f /var/lock/subsys/ncpa 2>/dev/null || true

echo "NCPA: Pre-removal completed."
